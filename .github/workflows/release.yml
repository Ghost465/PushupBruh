name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug
      
    - name: Build Release APK
      run: ./gradlew assembleRelease
      
    - name: Get version info
      id: version_info
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="latest-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "app_version=$(grep 'versionName' app/build.gradle | sed 's/.*"\(.*\)".*/\1/')" >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version_info.outputs.version }}
        release_name: PushupBruh ${{ steps.version_info.outputs.version }}
        body: |
          ## PushupBruh ${{ steps.version_info.outputs.version }}
          
          ### Changes:
          - Updated Android SDK and dependencies
          - Fixed deprecated API warnings
          - Enabled configuration cache for better performance
          
          ### Installation:
          1. Download the APK below
          2. Enable "Install from unknown sources" on your device
          3. Install the APK
          
          **App Version:** ${{ steps.version_info.outputs.app_version }}
          **Build Date:** ${{ github.event.head_commit.timestamp }}
        draft: false
        prerelease: false
        
    - name: Find APK files
      id: find_apks
      run: |
        echo "debug_apk=$(find app/build/outputs/apk/debug -name '*.apk' -type f | head -1)" >> $GITHUB_OUTPUT
        echo "release_apk=$(find app/build/outputs/apk/release -name '*.apk' -type f | head -1)" >> $GITHUB_OUTPUT
        
    - name: Upload Debug APK
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_apks.outputs.debug_apk }}
        asset_name: PushupBruh-debug-v${{ steps.version_info.outputs.app_version }}.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: Upload Release APK
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_apks.outputs.release_apk }}
        asset_name: PushupBruh-release-v${{ steps.version_info.outputs.app_version }}.apk
        asset_content_type: application/vnd.android.package-archive
